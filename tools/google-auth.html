<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HIVE888 • Auth Test</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #0b1020; color: #e8eefc; }
      .wrap { max-width: 980px; margin: 0 auto; padding: 28px 18px 60px; }
      .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 16px; margin-top: 14px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      .muted { color: rgba(232,238,252,0.72); font-size: 13px; }
      label { display:block; font-size: 12px; margin: 10px 0 6px; color: rgba(232,238,252,0.8); }
      input, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.20); color: #e8eefc; outline: none; }
      textarea { min-height: 180px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      @media (max-width: 900px){ .row { grid-template-columns: 1fr; } }
      button { background: #4f46e5; color: #fff; border: 0; border-radius: 10px; padding: 10px 12px; cursor: pointer; font-weight: 600; }
      button.secondary { background: rgba(255,255,255,0.10); }
      .btns { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; margin-top: 10px; }
      .pill { display:inline-block; padding: 3px 10px; border-radius: 999px; background: rgba(79,70,229,0.22); border: 1px solid rgba(79,70,229,0.45); font-size: 12px; }
      code { background: rgba(0,0,0,0.25); padding: 2px 6px; border-radius: 8px; }
      .ok { color: #86efac; }
      .bad { color: #fca5a5; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>HIVE888 • Auth Test Page</h1>
      <div class="muted">
        This page is served by the backend at <code>/tools/google-auth</code>. It calls your API on the same origin (example: <code>http://localhost:3000</code>).
      </div>

      <div class="card">
        <div class="pill">1) Normal login</div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Email (username)</label>
            <input id="email" placeholder="email@example.com" />
          </div>
          <div>
            <label>Password</label>
            <input id="password" type="password" placeholder="••••••••" />
          </div>
        </div>
        <div class="btns">
          <button id="btnLogin">POST /api/auth/login</button>
          <button id="btnMe" class="secondary">GET /api/customers/me</button>
          <button id="btnLogout" class="secondary">Clear tokens</button>
          <span id="tokenState" class="muted"></span>
        </div>
      </div>

      <div class="card">
        <div class="pill">2) Google login (ID token → backend)</div>
        <div class="muted" style="margin-top:8px;">
          Requires <code>GOOGLE_CLIENT_ID</code> to be set on the server. The backend endpoint is <code>POST /api/auth/google-login</code>.
        </div>
        <div id="g_id_onload"
          data-client_id="__GOOGLE_CLIENT_ID__"
          data-callback="onGoogleCredential"
          data-auto_prompt="false">
        </div>
        <div class="btns" style="margin-top:10px;">
          <div class="g_id_signin"
            data-type="standard"
            data-size="large"
            data-theme="outline"
            data-text="continue_with"
            data-shape="rectangular"
            data-logo_alignment="left">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pill">Output</div>
        <label>Last response</label>
        <textarea id="out" readonly></textarea>
      </div>
    </div>

    <script>
      const out = document.getElementById('out');
      const tokenState = document.getElementById('tokenState');

      function setOutput(obj) {
        out.value = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
        out.scrollTop = out.scrollHeight;
      }

      function setTokens(accessToken, refreshToken) {
        if (accessToken) localStorage.setItem('accessToken', accessToken);
        if (refreshToken) localStorage.setItem('refreshToken', refreshToken);
        refreshTokenState();
      }

      function clearTokens() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        refreshTokenState();
      }

      function refreshTokenState() {
        const at = localStorage.getItem('accessToken');
        tokenState.textContent = at ? 'accessToken: present' : 'accessToken: missing';
        tokenState.className = at ? 'ok' : 'bad';
      }

      async function api(path, { method = 'GET', body, auth = false } = {}) {
        const headers = { 'Content-Type': 'application/json' };
        if (auth) {
          const at = localStorage.getItem('accessToken');
          if (at) headers['Authorization'] = `Bearer ${at}`;
        }
        const res = await fetch(path, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined,
        });
        const text = await res.text();
        let json = null;
        try { json = JSON.parse(text); } catch (_) {}
        return { status: res.status, ok: res.ok, data: json ?? text };
      }

      document.getElementById('btnLogin').addEventListener('click', async () => {
        const username = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const resp = await api('/api/auth/login', { method: 'POST', body: { username, password } });
        setOutput(resp);
        if (resp.ok && resp.data?.data?.accessToken) {
          setTokens(resp.data.data.accessToken, resp.data.data.refreshToken);
        }
      });

      document.getElementById('btnMe').addEventListener('click', async () => {
        const resp = await api('/api/customers/me', { method: 'GET', auth: true });
        setOutput(resp);
      });

      document.getElementById('btnLogout').addEventListener('click', () => {
        clearTokens();
        setOutput({ ok: true, message: 'cleared tokens' });
      });

      // Called by Google's GSI script
      async function onGoogleCredential(response) {
        try {
          const token = response && response.credential;
          if (!token) {
            setOutput({ ok: false, error: 'No credential returned from Google' });
            return;
          }
          const resp = await api('/api/auth/google-login', { method: 'POST', body: { token } });
          setOutput(resp);
          if (resp.ok && resp.data?.data?.accessToken) {
            setTokens(resp.data.data.accessToken, resp.data.data.refreshToken);
          }
        } catch (e) {
          setOutput({ ok: false, error: String(e?.message || e) });
        }
      }
      window.onGoogleCredential = onGoogleCredential;

      // Try to fetch client id from backend config endpoint if available; otherwise keep empty.
      // Backend will still work even if the button renders without it? (It won't.) So we show a helpful message.
      (function init() {
        refreshTokenState();
        setOutput({ note: "If the Google button doesn't render, confirm GOOGLE_CLIENT_ID is set on the server and restart. This page needs the client id to render Google's button." });
      })();
    </script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </body>
</html>


